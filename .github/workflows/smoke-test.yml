name: Smoke Test Docker Image

on:
  pull_request:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install pnpm
        run: npm i -g pnpm@9
      - name: Generate frontend assets
        run: make node-generate-prod
      - name: Build Docker image
        run: |
          docker build --pull --build-arg REVISION=${{ github.sha }} -t opencloud/opencloud:smoke .
      - name: Init config in container
        run: |
          mkdir -p ./tmp-oc
          docker run --rm -v $PWD/tmp-oc:/root/.opencloud opencloud/opencloud:smoke init --insecure true --admin-password admin
      - name: Start server
        run: |
          docker run -d --name oc-smoke -v $PWD/tmp-oc:/root/.opencloud -p 127.0.0.1:9201:9200 -p 127.0.0.1:5201:5200 -p 127.0.0.1:9175:9174 opencloud/opencloud:smoke server
      - name: Wait for server and check HTTPS
        run: |
          for i in $(seq 1 30); do
            if curl -k -sSf https://127.0.0.1:9201/ >/dev/null 2>&1; then
              echo "server ready"
              exit 0
            fi
            sleep 2
          done
          echo "server failed to start, container logs:" && docker logs oc-smoke || true
          exit 1
      - name: Cleanup
        if: always()
        run: |
          docker rm -f oc-smoke || true
          rm -rf tmp-oc
